<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Star Public School - Provisional Certificate</title>

<link rel="stylesheet" href="style.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- ‚úÖ html2pdf LIBRARY (MOST IMPORTANT FIX) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Extra reliability for 1-page perfect fit -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  margin:0;
  font-family:"Roboto", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

.prov-main{
  width: min(var(--max), 92%);
  margin: 0 auto;
  padding: 120px 0 54px;
}

.prov-topbar{
  display:flex;
  justify-content:flex-end;
  margin-bottom: 12px;
}

.prov-logout{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius: 12px;
  border: 1px solid rgba(220, 53, 69, 0.22);
  background: rgba(220, 53, 69, 0.08);
  color: rgba(185, 28, 28, 0.95);
  font-weight: 700;
  cursor: pointer;
}

.prov-logout:hover{
  background: rgba(220, 53, 69, 0.12);
}

/* SEARCH CARD */
.search-card{
  max-width: 520px;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.92);
  padding: 22px 18px;
  border-radius: 20px;
  border: 1px solid rgba(11, 27, 58, 0.12);
  box-shadow: 0 18px 44px rgba(11, 27, 58, 0.14);
  text-align: left;
}
.input{
  width:100%;
  padding: 12px 12px;
  margin-bottom: 12px;
  border: 1px solid rgba(11, 27, 58, 0.16);
  border-radius: 12px;
  text-align: left;
  outline: none;
  font-size: 15px;
}
.input:focus{
  border-color: rgba(11, 95, 255, 0.35);
  box-shadow: 0 0 0 3px rgba(11, 95, 255, 0.15);
}

.search-title{
  margin: 4px 0 6px;
  font-size: 24px;
  letter-spacing: -0.2px;
}

.search-sub{
  margin: 0 0 14px;
  color: rgba(11, 27, 58, 0.70);
  line-height: 1.6;
}

.search-actions{
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
}

.search-actions .btn{
  flex: 1;
  min-width: 220px;
}

/* ================= CERTIFICATE ================= */
.wrap{
  display:flex;
  justify-content:center;
  margin-top: 18px;
}

.cert{
  width:210mm;
  height:140mm;
  position:relative;
  display:none;
  background-image:url("content/boarderimg.png");
  background-color: #feecc4;
  background-size:100% 100%;
  background-repeat:no-repeat;
  padding:90px 95px;
  box-sizing:border-box;
}

/* During PDF capture: remove shadow to avoid layout overflow */
.cert.pdf-capture{
  box-shadow:none;
}

/* TOP LEFT LOGO */
.cert-logo{
  position:absolute;
  top:80px;
  left:85px;
  height:55px;
}

/* PC NUMBER */
.pc-no{
  position:absolute;
  top:65px;
  right:100px;
  font-size:13px;
  font-weight:700;
  color:#7a4f00;
}

/* HEAD */
.head{text-align:center;margin-top:-15px;}
.head .hindi{
  font-size:24px;
  color:#8b0000;
  font-weight:900;
}
.head .english{
  font-size:18px;
  color:#8b0000;
  font-weight:800;
  margin-top:-4px;
}
.head .sub{
  font-size:14px;
  color:#444;
  letter-spacing:1px;
  margin-top:6px;
}

/* BODY */
.body{
  margin-top:35px;
  font-size:15px;
  line-height:2;
}
.label{
  display:inline-block;
  width:150px;
  color:#555;
}
.value{
  font-weight:800;
  text-transform:uppercase;
}
#division{color:#8b0000;}

/* STAMP */
.cert-stamp-box{
  position:absolute;
  right:180px;
  bottom:155px;
}
.cert-stamp-box img{
  height:100px;
  opacity:0.85;
}

/* CERTIFICATE FOOTER (scoped) */
.cert-footer{
  position:absolute;
  bottom:65px;
  left:95px;
  right:95px;
  display:flex;
  justify-content:space-between;
}
.cert-footer strong{
  font-size:16px;
  border-bottom:2px solid #b08a2e;
}

/* ACTION BUTTONS */
#certActions{
  display:none;
  justify-content:center;
  gap:20px;
  margin: 18px auto 0;
  width: min(var(--max), 92%);
}
#certActions .btn{
  background:linear-gradient(135deg,#caa24d,#f1d27a);
  color:#3b2600;
}
</style>
</head>

<body class="provisional-page">

  <!-- Navbar (same as site) -->
  <nav class="nav" aria-label="Primary">
    <a class="brand" href="index.html" aria-label="Star Public School Home">
      <img src="content/logo.jpeg" alt="Star Public School logo">
      <span class="brand-name">Star Public School</span>
    </a>

    <div class="nav-links" id="navLinks" aria-label="Site links">
      <button class="nav-icon close" type="button" onclick="hideMenu()" aria-label="Close menu">
        <i class="fa fa-times" aria-hidden="true"></i>
      </button>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="result.html">Result</a></li>
        <li><a href="admin.html">Admin</a></li>
      </ul>
    </div>

    <button class="nav-icon open" type="button" onclick="showMenu()" aria-label="Open menu">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </button>
  </nav>

  <main class="prov-main">
    <div class="prov-topbar">
      <button id="logoutBtn" class="prov-logout" type="button">
        <i class="fa fa-sign-out" aria-hidden="true"></i>
        Logout
      </button>
    </div>

    <div class="search-card">
      <h2 class="search-title">Provisional Certificate</h2>
      <p class="search-sub">Enter class and roll number to generate the provisional certificate and download as PDF.</p>
      <input id="classInput" class="input" placeholder="Enter Class">
      <input id="rollInput" class="input" placeholder="Enter Roll Number">
      <div class="search-actions">
        <button class="btn primary" id="searchBtn" type="button">Search</button>
      </div>
    </div>

    <div class="wrap">
      <div class="cert" id="certificate">

  <img src="content/logo.jpeg" class="cert-logo">

  <div class="pc-no">P.C. No. <span id="pcNo"></span></div>

  <div class="head">
    <div class="hindi">‡§¨‡§ø‡§π‡§æ‡§∞ ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§∏‡§Æ‡§ø‡§§‡§ø, ‡§™‡§ü‡§®‡§æ</div>
    <div class="english">BIHAR SCHOOL EXAMINATION BOARD, PATNA</div>
    <div class="sub">PROVISIONAL CERTIFICATE</div>
  </div>

  <div class="body">
    Certified that <span class="value" id="studentName"></span>,
    Son/Daughter of <span class="value" id="fatherName"></span>,
    has passed the <span class="value" id="year"></span>
    from <span class="value" id="schoolName"></span>.
    <br><br>

    <div><span class="label">Class</span> <span class="value" id="classVal"></span></div>
    <div><span class="label">Roll No.</span> <span class="value" id="rollNo"></span></div>
    <div><span class="label">Division</span> <span class="value" id="division"></span></div>
  </div>

  <div class="cert-stamp-box">
    <img src="content/stampcert.png">
  </div>

  <div class="cert-footer">
    <div>Patna, Dated: <span class="value" id="dateVal"></span></div>
    <div>
      <strong>Ajay Kumar Giri</strong><br>
      <small>Controller of Examination</small>
    </div>
  </div>

</div>
</div>

<div id="certActions">
  <button class="btn ghost" id="searchMoreBtn" type="button">Search More</button>
  <button class="btn primary" id="downloadBtn" type="button">Download</button>
</div>

<script>
function fillCertificate(d){
  studentName.textContent=d.studentName||'';
  fatherName.textContent=d.fatherName||'';
  schoolName.textContent=d.schoolName||'';
  classVal.textContent=d.class||'';
  rollNo.textContent=d.rollNo||'';
  division.textContent=d.division||'';
  year.textContent=d.year||'';
  dateVal.textContent=d.date||'';
  pcNo.textContent=d.pcNo||'';
}

searchBtn.onclick=async()=>{
  const c=classInput.value.trim();
  const r=rollInput.value.trim();
  if(!c||!r) return alert("Enter Class & Roll");

  const res=await fetch(`/provisional?class=${c}&roll=${r}`);
  const data=await res.json();
  if(data.error) return alert(data.error);
  if (!data.division || data.division.toLowerCase() === "incomplete") {
    alert("‚ùå Result is incomplete. Provisional Certificate cannot be generated.");
    return;
  }
  fillCertificate(data);
  document.querySelector('.search-card').style.display='none';
  certificate.style.display='block';
  certActions.style.display='flex';
}

searchMoreBtn.onclick=()=>{
  certificate.style.display='none';
  certActions.style.display='none';
  document.querySelector('.search-card').style.display='block';
}

downloadBtn.onclick = () => {
  (async function () {
    const el = document.getElementById('certificate');
    if (!el) return;

    try {
      if (document.fonts && document.fonts.ready) await document.fonts.ready;
    } catch (e) {}

    const imgs = Array.from(el.querySelectorAll('img'));
    await Promise.all(imgs.map(img => new Promise(resolve => {
      if (img.complete) return resolve();
      img.onload = resolve;
      img.onerror = resolve;
    })));

    el.classList.add('pdf-capture');

    const canvas = await html2canvas(el, {
      scale: 3,
      useCORS: true,
      backgroundColor: null
    });

    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const jspdf = window.jspdf.jsPDF;

    // ‚úÖ A4 PORTRAIT
    const pdf = new jspdf({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });

    const pageW = pdf.internal.pageSize.getWidth();   // 210mm

    // üîπ Maintain aspect ratio
    const imgW = pageW;
    const imgH = (canvas.height * imgW) / canvas.width;

    // ‚úÖ TOP = 0 (NO MARGIN)
    pdf.addImage(imgData, 'JPEG', 0, 0, imgW, imgH, undefined, 'FAST');

    pdf.save('provisional-certificate-A4.pdf');

    el.classList.remove('pdf-capture');
  })();
};

// Optional logout (if backend route exists)
logoutBtn && (logoutBtn.onclick = async () => {
  try {
    // If your server has logout route, it will work; otherwise it will just go back home.
    await fetch("/admin/logout", { method: "POST" });
  } catch (e) {}
  window.location.href = "index.html";
});
</script>

  </main>

  <footer class="footer" aria-label="Footer">
    <div class="footer-container">
      <div class="footer-grid">
        <div class="footer-brand">
          <div class="footer-brand-row">
            <img class="footer-logo" src="content/logo.jpeg" alt="Star Public School logo">
            <div>
              <div class="footer-title">Star Public School</div>
              <div class="footer-tagline">Learning ‚Ä¢ Values ‚Ä¢ Excellence</div>
            </div>
          </div>
          <p class="footer-text">
            A trusted CBSE English medium school focused on strong academics, discipline, and holistic development.
          </p>
          <div class="footer-social" aria-label="Social links">
            <a class="social-btn" href="#" aria-label="Facebook"><i class="fa fa-facebook" aria-hidden="true"></i></a>
            <a class="social-btn" href="#" aria-label="Instagram"><i class="fa fa-instagram" aria-hidden="true"></i></a>
            <a class="social-btn" href="#" aria-label="YouTube"><i class="fa fa-youtube-play" aria-hidden="true"></i></a>
          </div>
        </div>

        <div class="footer-col">
          <div class="footer-subtitle">Quick Links</div>
          <ul class="footer-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="result.html">Result</a></li>
            <li><a href="admin.html">Admin</a></li>
          </ul>
        </div>

        <div class="footer-col">
          <div class="footer-subtitle">Contact</div>
          <ul class="footer-contact">
            <li><i class="fa fa-map-marker" aria-hidden="true"></i><span>Meghwal Mathia, Post - Mathia, District - West Champaran</span></li>
            <li><i class="fa fa-phone" aria-hidden="true"></i><span><a href="tel:+919006457330">+91 9006457330</a></span></li>
            <li><i class="fa fa-envelope" aria-hidden="true"></i><span><a href="mailto:a9006457330@gmail.com">a9006457330@gmail.com</a></span></li>
          </ul>
        </div>
      </div>

      <div class="footer-bottom">
        <p class="footer-copy">&copy; 2016 Star Public School. All rights reserved.</p>
        <div class="footer-legal">
          <a href="#">Privacy Policy</a>
          <a href="#">Terms of Service</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // Mobile menu (same behavior as homepage)
    var navLinks = document.getElementById("navLinks");
    function showMenu() { navLinks.style.right = "0"; }
    function hideMenu() { navLinks.style.right = "-320px"; }
    if (navLinks) {
      navLinks.querySelectorAll("a").forEach(function (a) {
        a.addEventListener("click", hideMenu);
      });
    }
  </script>

</body>
</html>
